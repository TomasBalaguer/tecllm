{% extends "base.html" %}
{% block title %}Logs - {{ tenant.name }}{% endblock %}
{% block content %}
<div class="mb-6">
    <a href="/admin/tenants/{{ tenant.id }}" class="text-indigo-600 hover:underline">&larr; Volver a {{ tenant.name }}</a>
</div>

<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-3xl font-bold">Query Logs</h1>
        <p class="text-gray-500">{{ tenant.name }} - Historial de consultas a la API</p>
    </div>
    <div class="text-sm text-gray-500">
        Total: {{ total }} logs
    </div>
</div>

<!-- Filters -->
<div class="bg-white p-4 rounded-lg shadow mb-6">
    <form method="get" class="flex gap-4 items-end">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
            <select name="status" class="border rounded px-3 py-2 text-sm">
                <option value="">Todos</option>
                <option value="success" {% if status_filter == 'success' %}selected{% endif %}>Success</option>
                <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Asistente</label>
            <select name="assistant_id" class="border rounded px-3 py-2 text-sm">
                <option value="">Todos</option>
                {% for a in assistants %}
                <option value="{{ a.id }}" {% if assistant_filter == a.id|string %}selected{% endif %}>{{ a.name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700">
            Filtrar
        </button>
        <a href="/admin/tenants/{{ tenant.id }}/logs" class="text-gray-500 hover:text-gray-700 text-sm">
            Limpiar filtros
        </a>
    </form>
</div>

<!-- Logs Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    {% if logs %}
    <table class="w-full">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Query ID</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Message</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chunks</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tiempo</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
            </tr>
        </thead>
        <tbody class="divide-y">
            {% for log in logs %}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap">
                    {{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                </td>
                <td class="px-4 py-3 font-mono text-xs text-gray-500">
                    {{ log.query_id[:8] }}...
                </td>
                <td class="px-4 py-3 text-sm max-w-md">
                    <div class="truncate" title="{{ log.message_preview }}">
                        {{ log.message_preview[:100] }}{% if log.message_preview|length > 100 %}...{% endif %}
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-center">
                    {{ log.knowledge_chunks_used }}
                </td>
                <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap">
                    {{ log.processing_time_ms }}ms
                    {% if log.cached %}
                    <span class="ml-1 px-1.5 py-0.5 text-xs bg-purple-100 text-purple-700 rounded">cached</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3">
                    {% if log.status == 'success' %}
                    <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Success</span>
                    {% else %}
                    <span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded">Error</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3">
                    <a href="/admin/tenants/{{ tenant.id }}/logs/{{ log.query_id }}"
                       class="text-indigo-600 hover:underline text-sm">
                        Ver detalle
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t">
        <div class="text-sm text-gray-500">
            Mostrando {{ offset + 1 }} - {{ offset + logs|length }} de {{ total }}
        </div>
        <div class="flex gap-2">
            {% if offset > 0 %}
            <a href="?offset={{ offset - limit }}&limit={{ limit }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if assistant_filter %}&assistant_id={{ assistant_filter }}{% endif %}"
               class="px-3 py-1 border rounded text-sm hover:bg-gray-100">
                Anterior
            </a>
            {% endif %}
            {% if offset + limit < total %}
            <a href="?offset={{ offset + limit }}&limit={{ limit }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if assistant_filter %}&assistant_id={{ assistant_filter }}{% endif %}"
               class="px-3 py-1 border rounded text-sm hover:bg-gray-100">
                Siguiente
            </a>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="p-8 text-center text-gray-500">
        <p>No hay logs disponibles.</p>
        <p class="text-sm mt-2">Los logs aparecerán aquí cuando se realicen consultas a la API.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
